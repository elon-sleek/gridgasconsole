name: Deploy (cPanel)

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: cpanel-deploy
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Build
        env:
          # Public runtime config is baked into the build output.
          # Use GitHub Secrets so the deployed client bundle points at the real services.
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_TB_BASE_URL: ${{ secrets.NEXT_PUBLIC_TB_BASE_URL }}
          NEXT_PUBLIC_MAP_API_KEY: ${{ secrets.NEXT_PUBLIC_MAP_API_KEY }}
        run: npm run build

      - name: Prepare deploy bundle (Next standalone)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf deploy
          mkdir -p deploy

          if [ ! -f .next/standalone/server.js ]; then
            echo "Expected .next/standalone/server.js (standalone build)."
            echo "Make sure next.config.mjs has: output: 'standalone'"
            exit 1
          fi

          # Keep the standalone output under `.next/standalone` (Next.js recommended).
          # We'll run it by `chdir`-ing into that directory from our startup wrapper.
          mkdir -p deploy/.next
          cp -R .next/standalone deploy/.next/

          # Next requires static assets to be present at `.next/static` relative to the standalone dir.
          mkdir -p deploy/.next/standalone/.next
          cp -R .next/static deploy/.next/standalone/.next/static

          # Public assets should also be alongside the standalone server.
          if [ -d public ]; then
            cp -R public deploy/.next/standalone/public
          fi

          # cPanel startup wrapper at the app root.
          cp server.js deploy/server.js

      - name: Configure SSH
        shell: bash
        env:
          CPANEL_HOST: ${{ secrets.CPANEL_HOST }}
          CPANEL_SSH_PORT: ${{ secrets.CPANEL_SSH_PORT }}
          CPANEL_SSH_KEY: ${{ secrets.CPANEL_SSH_KEY }}
        run: |
          set -euo pipefail

          if [ -z "${CPANEL_HOST}" ] || [ -z "${CPANEL_SSH_KEY}" ]; then
            echo "Missing required secrets: CPANEL_HOST and/or CPANEL_SSH_KEY"
            exit 1
          fi

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "${CPANEL_SSH_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          PORT="${CPANEL_SSH_PORT:-22}"
          ssh-keyscan -p "${PORT}" -H "${CPANEL_HOST}" >> ~/.ssh/known_hosts

      - name: Deploy via tar+scp
        shell: bash
        env:
          CPANEL_HOST: ${{ secrets.CPANEL_HOST }}
          CPANEL_USER: ${{ secrets.CPANEL_USER }}
          CPANEL_SSH_PORT: ${{ secrets.CPANEL_SSH_PORT }}
          CPANEL_DEPLOY_PATH: ${{ secrets.CPANEL_DEPLOY_PATH }}
        run: |
          set -euo pipefail

          if [ -z "${CPANEL_USER}" ] || [ -z "${CPANEL_DEPLOY_PATH}" ]; then
            echo "Missing required secrets: CPANEL_USER and/or CPANEL_DEPLOY_PATH"
            exit 1
          fi

          PORT="${CPANEL_SSH_PORT:-22}"
          SSH="ssh -i ~/.ssh/id_ed25519 -p ${PORT}"
          REMOTE="${CPANEL_USER}@${CPANEL_HOST}"
          DEPLOY_DIR="${CPANEL_DEPLOY_PATH%/}"

          # 1. Create a tarball of the deploy bundle (excludes .env files).
          tar czf /tmp/deploy.tar.gz -C deploy .

          # 2. Upload the tarball.
          scp -i ~/.ssh/id_ed25519 -P "${PORT}" /tmp/deploy.tar.gz "${REMOTE}:/tmp/deploy.tar.gz"

          # 3. On the server: back up .env, wipe the deploy dir, extract, restore .env.
          ${SSH} "${REMOTE}" bash -s <<SCRIPT
            set -euo pipefail
            mkdir -p "${DEPLOY_DIR}"

            # Preserve any existing .env* files.
            if ls "${DEPLOY_DIR}"/.env* 1>/dev/null 2>&1; then
              cp "${DEPLOY_DIR}"/.env* /tmp/_env_backup/ 2>/dev/null || {
                mkdir -p /tmp/_env_backup
                cp "${DEPLOY_DIR}"/.env* /tmp/_env_backup/
              }
            fi

            # Clean old deploy and extract new bundle.
            find "${DEPLOY_DIR}" -mindepth 1 -not -name '.env*' -delete 2>/dev/null || true
            tar xzf /tmp/deploy.tar.gz -C "${DEPLOY_DIR}"

            # Restore .env files.
            if ls /tmp/_env_backup/.env* 1>/dev/null 2>&1; then
              cp /tmp/_env_backup/.env* "${DEPLOY_DIR}/"
              rm -rf /tmp/_env_backup
            fi

            rm -f /tmp/deploy.tar.gz
          SCRIPT

      - name: Restart cPanel Node app (Passenger)
        shell: bash
        env:
          CPANEL_HOST: ${{ secrets.CPANEL_HOST }}
          CPANEL_USER: ${{ secrets.CPANEL_USER }}
          CPANEL_SSH_PORT: ${{ secrets.CPANEL_SSH_PORT }}
          CPANEL_DEPLOY_PATH: ${{ secrets.CPANEL_DEPLOY_PATH }}
        run: |
          set -euo pipefail
          PORT="${CPANEL_SSH_PORT:-22}"

          # Most cPanel Node apps (Passenger) restart when tmp/restart.txt changes.
          ssh -i ~/.ssh/id_ed25519 -p "${PORT}" "${CPANEL_USER}@${CPANEL_HOST}" \
            "mkdir -p '${CPANEL_DEPLOY_PATH%/}/tmp' && touch '${CPANEL_DEPLOY_PATH%/}/tmp/restart.txt'"
